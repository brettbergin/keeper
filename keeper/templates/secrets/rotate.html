{% extends "base.html" %}

{% block title %}Rotate {{ secret.name }} - Keeper{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with breadcrumb -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('secrets.index') }}">Secrets</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('secrets.detail', id=secret.id) }}">{{ secret.name }}</a></li>
                    <li class="breadcrumb-item active">Rotate</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-redo me-2 text-primary"></i>Rotate Secret</h2>
                    <p class="text-muted mb-0">Create a new version of {{ secret.name }} with AB rotation</p>
                </div>
                <div>
                    <a href="{{ url_for('secrets.detail', id=secret.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Details
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Main Rotation Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-key me-2"></i>AB Key Rotation</h5>
                </div>
                <div class="card-body">
                    <!-- Rotation Strategy Info -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>AB Rotation Strategy</h6>
                        <p class="mb-2">This creates a new version (B) while keeping the current version (A) active until sync is complete:</p>
                        <ol class="mb-0">
                            <li>New version is created with updated value</li>
                            <li>External services sync to the new version</li>
                            <li>Previous version remains available for rollback</li>
                            <li>Gradual cutover ensures zero downtime</li>
                        </ol>
                    </div>

                    <form method="POST" id="rotateForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Generation Method -->
                        <div class="mb-4">
                            <label class="form-label">Rotation Method <span class="text-danger">*</span></label>
                            {% if current_user and current_user.can_manually_enter_secrets() %}
                            <!-- Admin users can use all rotation methods -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card h-100 method-card" data-method="auto">
                                        <div class="card-body text-center">
                                            <i class="fas fa-magic fa-2x text-primary mb-2"></i>
                                            <h6>Auto-Generate</h6>
                                            <p class="small text-muted mb-0">Generate new value based on secret type</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 method-card" data-method="manual">
                                        <div class="card-body text-center">
                                            <i class="fas fa-edit fa-2x text-warning mb-2"></i>
                                            <h6>Manual Entry</h6>
                                            <p class="small text-muted mb-0">Provide your own replacement value</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 method-card" data-method="imported">
                                        <div class="card-body text-center">
                                            <i class="fas fa-upload fa-2x text-success mb-2"></i>
                                            <h6>Import</h6>
                                            <p class="small text-muted mb-0">Import from external source</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <!-- Non-admin users can only use auto-generation -->
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Auto-Generate Only:</strong> For security reasons, only administrators can manually enter or import secret values.
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card h-100 method-card active" data-method="auto">
                                        <div class="card-body text-center">
                                            <i class="fas fa-magic fa-2x text-primary mb-2"></i>
                                            <h6>Auto-Generate</h6>
                                            <p class="small text-muted mb-0">Generate new secure value based on secret type</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="generation_method" value="auto">
                            {% endif %}
                            <input type="hidden" name="generation_method" id="generation_method" required>
                        </div>

                        <!-- Auto-Generation Options -->
                        <div id="autoOptions" class="mb-4" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-cog me-2"></i>Generation Settings</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="length" class="form-label">Length</label>
                                            <input type="number" class="form-control" id="length" name="length" 
                                                   value="{{ '16' if secret.secret_type.value == 'password' else '32' }}" min="8" max="128">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="complexity" class="form-label">Complexity</label>
                                            <select class="form-select" id="complexity" name="complexity">
                                                <option value="standard">Standard (letters, numbers)</option>
                                                <option value="complex" selected>Complex (letters, numbers, symbols)</option>
                                                <option value="alphanumeric">Alphanumeric only</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" id="generatePreview">
                                            <i class="fas fa-eye me-1"></i>Preview Generated Value
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Entry (Admin Only) -->
                        {% if current_user and current_user.can_manually_enter_secrets() %}
                        <div id="manualOptions" class="mb-4" style="display: none;">
                            <label for="new_value" class="form-label">New Secret Value <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <textarea class="form-control font-monospace" id="new_value" name="new_value" rows="4"
                                          placeholder="Enter the new secret value..."></textarea>
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewValue">
                                    <i class="fas fa-eye" id="toggleNewIcon"></i>
                                </button>
                            </div>
                            <div class="form-text">This will become the new active version of the secret</div>
                        </div>
                        {% endif %}

                        <!-- Import Options (Admin Only) -->
                        {% if current_user and current_user.can_manually_enter_secrets() %}
                        <div id="importOptions" class="mb-4" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-download me-2"></i>Import Source</h6>
                                    <div class="mb-3">
                                        <label for="import_source" class="form-label">Source</label>
                                        <select class="form-select" id="import_source" name="import_source">
                                            <option value="">Select import source...</option>
                                            <option value="aws">AWS Secrets Manager</option>
                                            <option value="vault">HashiCorp Vault</option>
                                            <option value="file">File Upload</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="import_path" class="form-label">Path/ARN</label>
                                        <input type="text" class="form-control" id="import_path" name="import_path"
                                               placeholder="arn:aws:secretsmanager:region:account:secret:name or vault/path">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Rotation Options -->
                        <div class="mb-4">
                            <h6><i class="fas fa-clock me-2"></i>Rotation Options</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="immediate_activate" name="immediate_activate" checked>
                                        <label class="form-check-label" for="immediate_activate">
                                            Activate immediately
                                        </label>
                                        <div class="form-text">Make this version current after creation</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto_sync" name="auto_sync" checked>
                                        <label class="form-check-label" for="auto_sync">
                                            Sync to external backends
                                        </label>
                                        <div class="form-text">Push to AWS Secrets Manager and Vault</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Rotation -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="schedule_rotation" name="schedule_rotation">
                                <label class="form-check-label" for="schedule_rotation">
                                    Schedule future rotations
                                </label>
                            </div>
                            <div id="scheduleOptions" class="mt-3" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="rotation_interval" class="form-label">Rotation Interval (days)</label>
                                        <input type="number" class="form-control" id="rotation_interval" name="rotation_interval" 
                                               value="90" min="1" max="365">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="next_rotation" class="form-label">Next Rotation Date</label>
                                        <input type="date" class="form-control" id="next_rotation" name="next_rotation">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-redo me-1"></i>Rotate Secret
                                </button>
                                <a href="{{ url_for('secrets.detail', id=secret.id) }}" class="btn btn-outline-secondary ms-2">
                                    Cancel
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-warning" id="testRotation">
                                    <i class="fas fa-flask me-1"></i>Test Rotation
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with Current Info -->
        <div class="col-lg-4">
            <!-- Current Version Info -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Current Version</h6>
                </div>
                <div class="card-body">
                    {% if current_version %}
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Version:</td>
                                <td><span class="badge bg-success">{{ current_version.version_number }}</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Created:</td>
                                <td>{{ current_version.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Method:</td>
                                <td>{{ current_version.generation_method or 'Manual' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Algorithm:</td>
                                <td>{{ current_version.encryption_algorithm.upper() }}</td>
                            </tr>
                        </table>
                    {% else %}
                        <p class="text-muted mb-0">No current version available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Rotation History -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Rotation History</h6>
                </div>
                <div class="card-body">
                    {% if versions %}
                        {% for version in versions[:5] %}
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <div>
                                <small class="fw-bold">v{{ version.version_number }}</small>
                                {% if version.is_current %}
                                    <span class="badge bg-success ms-1">Current</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ version.generation_method or 'manual' }}</small>
                            </div>
                            <small class="text-muted">{{ version.created_at.strftime('%m/%d %H:%M') }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No rotation history</p>
                    {% endif %}
                </div>
            </div>

            <!-- Security Notice -->
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Security Notice</h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Previous versions remain accessible for rollback</li>
                        <li>All rotations are logged and audited</li>
                        <li>External systems sync automatically</li>
                        <li>Zero downtime rotation guaranteed</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Method selection
document.querySelectorAll('.method-card').forEach(card => {
    card.addEventListener('click', function() {
        // Remove active class from all cards
        document.querySelectorAll('.method-card').forEach(c => c.classList.remove('border-primary'));
        
        // Add active class to clicked card
        this.classList.add('border-primary');
        
        // Set method value
        const method = this.dataset.method;
        document.getElementById('generation_method').value = method;
        
        // Show/hide options (safely handle missing elements for non-admins)
        document.getElementById('autoOptions').style.display = method === 'auto' ? 'block' : 'none';

        const manualOptions = document.getElementById('manualOptions');
        if (manualOptions) {
            manualOptions.style.display = method === 'manual' ? 'block' : 'none';
        }

        const importOptions = document.getElementById('importOptions');
        if (importOptions) {
            importOptions.style.display = method === 'imported' ? 'block' : 'none';
        }

        // Update required fields
        const newValueField = document.getElementById('new_value');
        if (newValueField && method === 'manual') {
            newValueField.required = true;
        } else if (newValueField) {
            newValueField.required = false;
        }
    });
});

// Schedule rotation toggle
document.getElementById('schedule_rotation').addEventListener('change', function() {
    document.getElementById('scheduleOptions').style.display = this.checked ? 'block' : 'none';
    
    // Set default next rotation date
    if (this.checked) {
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + parseInt(document.getElementById('rotation_interval').value || 90));
        document.getElementById('next_rotation').value = nextDate.toISOString().split('T')[0];
    }
});

// Update next rotation date when interval changes
document.getElementById('rotation_interval').addEventListener('change', function() {
    if (document.getElementById('schedule_rotation').checked) {
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + parseInt(this.value || 90));
        document.getElementById('next_rotation').value = nextDate.toISOString().split('T')[0];
    }
});

// Toggle new value visibility
document.getElementById('toggleNewValue').addEventListener('click', function() {
    const input = document.getElementById('new_value');
    const icon = document.getElementById('toggleNewIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
});

// Generate preview
document.getElementById('generatePreview').addEventListener('click', function() {
    const length = document.getElementById('length').value || 32;
    const complexity = document.getElementById('complexity').value;
    
    let charset = '';
    switch(complexity) {
        case 'alphanumeric':
            charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            break;
        case 'standard':
            charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            break;
        case 'complex':
            charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            break;
    }
    
    let result = '';
    for (let i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    // Show preview in modal or alert
    alert('Preview: ' + result.substring(0, 20) + '...\n\nThis is a preview. The actual value will be generated when you submit.');
});

// Test rotation
document.getElementById('testRotation').addEventListener('click', function() {
    alert('Test rotation would validate:\n• New value meets complexity requirements\n• External backends are accessible\n• Permissions are sufficient\n• No conflicts exist\n\nThis feature simulates rotation without making changes.');
});

// Form validation
document.getElementById('rotateForm').addEventListener('submit', function(e) {
    const method = document.getElementById('generation_method').value;
    
    if (!method) {
        e.preventDefault();
        alert('Please select a rotation method');
        return false;
    }
    
    if (method === 'manual') {
        const value = document.getElementById('new_value').value.trim();
        if (!value) {
            e.preventDefault();
            alert('Please enter a new value for manual rotation');
            return false;
        }
    }
    
    if (method === 'imported') {
        const source = document.getElementById('import_source').value;
        const path = document.getElementById('import_path').value.trim();
        if (!source || !path) {
            e.preventDefault();
            alert('Please select an import source and provide a path');
            return false;
        }
    }
});

// Default to manual method
document.querySelector('.method-card[data-method="manual"]').click();
</script>

<style>
.method-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid #dee2e6;
}

.method-card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
}

.method-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}