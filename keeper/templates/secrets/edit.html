{% extends "base.html" %}

{% block title %}Edit {{ secret.name }} - Keeper{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with breadcrumb -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('secrets.index') }}">Secrets</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('secrets.detail', id=secret.id) }}">{{ secret.name }}</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-edit me-2 text-primary"></i>Edit Secret</h2>
                    <p class="text-muted mb-0">Update secret information and value</p>
                </div>
                <div>
                    <a href="{{ url_for('secrets.detail', id=secret.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Details
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Edit Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-key me-2"></i>Secret Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="editSecretForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="display_name" class="form-label">Display Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="display_name" name="display_name" 
                                           value="{{ secret.display_name }}" required>
                                    <div class="form-text">Human-readable name for this secret</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ secret.name }}" readonly>
                                    <div class="form-text">System name (cannot be changed)</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service_name" class="form-label">Service Name</label>
                                    <input type="text" class="form-control" id="service_name" name="service_name" 
                                           value="{{ secret.service_name or '' }}" placeholder="e.g., database, api, cache">
                                    <div class="form-text">Service or component this secret belongs to</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="secrecy_level" class="form-label">Secrecy Level</label>
                                    <select class="form-select" id="secrecy_level" name="secrecy_level">
                                        <option value="low" {{ 'selected' if secret.secrecy_level.value == 'low' }}>Low</option>
                                        <option value="medium" {{ 'selected' if secret.secrecy_level.value == 'medium' }}>Medium</option>
                                        <option value="high" {{ 'selected' if secret.secrecy_level.value == 'high' }}>High</option>
                                        <option value="critical" {{ 'selected' if secret.secrecy_level.value == 'critical' }}>Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="secret_type" class="form-label">Type</label>
                                    <select class="form-select" id="secret_type" name="secret_type" disabled>
                                        <option value="string" {{ 'selected' if secret.secret_type.value == 'string' }}>String</option>
                                        <option value="password" {{ 'selected' if secret.secret_type.value == 'password' }}>Password</option>
                                        <option value="api_key" {{ 'selected' if secret.secret_type.value == 'api_key' }}>API Key</option>
                                        <option value="ssh_key" {{ 'selected' if secret.secret_type.value == 'ssh_key' }}>SSH Key</option>
                                        <option value="rsa_key" {{ 'selected' if secret.secret_type.value == 'rsa_key' }}>RSA Key</option>
                                        <option value="certificate" {{ 'selected' if secret.secret_type.value == 'certificate' }}>Certificate</option>
                                        <option value="json" {{ 'selected' if secret.secret_type.value == 'json' }}>JSON</option>
                                        <option value="yaml" {{ 'selected' if secret.secret_type.value == 'yaml' }}>YAML</option>
                                    </select>
                                    <div class="form-text">Secret type cannot be changed after creation</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="environment_name" class="form-label">Environment</label>
                                    <input type="text" class="form-control" id="environment_name" name="environment_name" 
                                           value="{{ secret.environment.display_name }}" readonly>
                                    <div class="form-text">Environment cannot be changed after creation</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ secret.description or '' }}</textarea>
                            <div class="form-text">Optional description for this secret</div>
                        </div>

                        <!-- Secret Value Section -->
                        <hr class="my-4">
                        <h6 class="mb-3"><i class="fas fa-lock me-2"></i>Secret Value</h6>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="updateValue" name="update_value">
                                <label class="form-check-label" for="updateValue">
                                    Update secret value (creates new version)
                                </label>
                            </div>
                        </div>

                        <div id="valueSection" style="display: none;">
                            <div class="mb-3">
                                <label for="value" class="form-label">New Value <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <textarea class="form-control font-monospace" id="value" name="value" rows="4" 
                                              placeholder="Enter the secret value..."></textarea>
                                    <button class="btn btn-outline-secondary" type="button" id="generateValue">
                                        <i class="fas fa-random me-1"></i>Generate
                                    </button>
                                </div>
                                <div class="form-text">Leave empty to keep current value</div>
                            </div>

                            <div class="mb-3">
                                <label for="generation_method" class="form-label">Generation Method</label>
                                <select class="form-select" id="generation_method" name="generation_method">
                                    <option value="manual">Manual Entry</option>
                                    <option value="auto">Auto-Generated</option>
                                    <option value="imported">Imported</option>
                                </select>
                            </div>
                        </div>

                        <!-- Synchronization Options -->
                        <hr class="my-4">
                        <h6 class="mb-3"><i class="fas fa-sync me-2"></i>Synchronization</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sync_to_aws" name="sync_to_aws" 
                                           {{ 'checked' if secret.aws_sync_status != 'disabled' }}>
                                    <label class="form-check-label" for="sync_to_aws">
                                        Sync to AWS Secrets Manager
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sync_to_vault" name="sync_to_vault"
                                           {{ 'checked' if secret.vault_sync_status != 'disabled' }}>
                                    <label class="form-check-label" for="sync_to_vault">
                                        Sync to HashiCorp Vault
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Update Secret
                                </button>
                                <a href="{{ url_for('secrets.detail', id=secret.id) }}" class="btn btn-outline-secondary ms-2">
                                    Cancel
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="fas fa-trash me-1"></i>Delete Secret
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with current information -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Current Information</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">Created:</td>
                            <td>{{ secret.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Updated:</td>
                            <td>{{ secret.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Version:</td>
                            <td>{{ current_version.version_number if current_version else 'None' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">AWS Status:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if secret.aws_sync_status.value == 'synced' else 'secondary' }}">
                                    {{ secret.aws_sync_status.value.replace('_', ' ').title() }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Vault Status:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if secret.vault_sync_status.value == 'synced' else 'secondary' }}">
                                    {{ secret.vault_sync_status.value.replace('_', ' ').title() }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Version History Preview -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Versions</h6>
                </div>
                <div class="card-body">
                    {% if versions %}
                        {% for version in versions[:5] %}
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <div>
                                <small class="fw-bold">v{{ version.version_number }}</small>
                                {% if version.is_current %}
                                    <span class="badge bg-success ms-1">Current</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ version.created_at.strftime('%m/%d %H:%M') }}</small>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-2">
                            <a href="{{ url_for('secrets.detail', id=secret.id) }}" class="btn btn-sm btn-outline-primary">
                                View All Versions
                            </a>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No versions available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the secret <strong>{{ secret.name }}</strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone. All versions and history will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('secrets.delete', id=secret.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Delete Secret
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle value section when checkbox is checked
document.getElementById('updateValue').addEventListener('change', function() {
    const valueSection = document.getElementById('valueSection');
    const valueField = document.getElementById('value');
    
    if (this.checked) {
        valueSection.style.display = 'block';
        valueField.required = true;
    } else {
        valueSection.style.display = 'none';
        valueField.required = false;
        valueField.value = '';
    }
});

// Generate value based on secret type
document.getElementById('generateValue').addEventListener('click', function() {
    const secretType = document.getElementById('secret_type').value;
    const valueField = document.getElementById('value');
    const methodField = document.getElementById('generation_method');
    
    // Simple generation examples (in a real app, this would call backend API)
    let generatedValue = '';
    
    switch(secretType) {
        case 'password':
            generatedValue = generatePassword(16);
            break;
        case 'api_key':
            generatedValue = generateApiKey();
            break;
        case 'string':
            generatedValue = generateRandomString(32);
            break;
        default:
            generatedValue = generateRandomString(32);
    }
    
    valueField.value = generatedValue;
    methodField.value = 'auto';
});

function generatePassword(length) {
    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return password;
}

function generateApiKey() {
    return 'ak_' + generateRandomString(32);
}

function generateRandomString(length) {
    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return result;
}

// Form validation
document.getElementById('editSecretForm').addEventListener('submit', function(e) {
    const updateValue = document.getElementById('updateValue').checked;
    const value = document.getElementById('value').value.trim();
    
    if (updateValue && !value) {
        e.preventDefault();
        alert('Please enter a value or uncheck "Update secret value"');
        return false;
    }
});
</script>
{% endblock %}