{% extends "base.html" %}

{% block title %}Create Secret - Keeper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-plus me-2"></i>Create Secret</h1>
            <a href="{{ url_for('secrets.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Secrets
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Secret Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="createSecretForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Secret Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="database-password" value="{{ request.form.get('name', '') }}">
                            <div class="form-text">Internal name (lowercase, alphanumeric, hyphens, underscores, dots only)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="display_name" class="form-label">Display Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="display_name" name="display_name" required
                                   placeholder="Database Password" value="{{ request.form.get('display_name', '') }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="Brief description of this secret">{{ request.form.get('description', '') }}</textarea>
                    </div>
                    
                    <!-- Environment and Service -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="environment_id" class="form-label">Environment <span class="text-danger">*</span></label>
                            <select class="form-select" id="environment_id" name="environment_id" required>
                                <option value="">Select Environment</option>
                                {% for env in environments %}
                                <option value="{{ env.id }}" {% if request.form.get('environment_id')|int == env.id %}selected{% endif %}>
                                    {{ env.display_name }}
                                    {% if env.is_production %} (Production){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="service_name" class="form-label">Service</label>
                            <input type="text" class="form-control" id="service_name" name="service_name"
                                   placeholder="postgresql, redis, api-service" 
                                   value="{{ request.form.get('service_name', '') }}">
                            <div class="form-text">Associated service or application</div>
                        </div>
                    </div>
                    
                    <!-- Secret Type and Security -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="secret_type" class="form-label">Secret Type</label>
                            <select class="form-select" id="secret_type" name="secret_type" onchange="updateSecretTypeHelp()">
                                {% for secret_type in secret_types %}
                                <option value="{{ secret_type.value }}" 
                                        {% if request.form.get('secret_type') == secret_type.value %}selected{% endif %}>
                                    {{ secret_type.value.replace('_', ' ').title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="secrecy_level" class="form-label">Secrecy Level</label>
                            <select class="form-select" id="secrecy_level" name="secrecy_level">
                                {% for level in secrecy_levels %}
                                <option value="{{ level.value }}" 
                                        {% if request.form.get('secrecy_level') == level.value %}selected{% endif %}>
                                    {{ level.value.title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Secret Value -->
                    <div class="mb-3">
                        <label for="value" class="form-label">Secret Value <span class="text-danger">*</span></label>

                        {% if current_user and current_user.can_manually_enter_secrets() %}
                        <!-- Admin users can manually enter or generate -->
                        <div class="input-group">
                            <textarea class="form-control" id="value" name="value" rows="4" required
                                      placeholder="Enter the secret value or use generate...">{{ request.form.get('value', '') }}</textarea>
                            <button class="btn btn-outline-secondary" type="button" id="generateBtn" onclick="generateSecret()">
                                <i class="fas fa-magic me-1"></i>Generate
                            </button>
                        </div>
                        <input type="hidden" name="generation_method" id="generation_method" value="manual">
                        {% else %}
                        <!-- Non-admin users must use auto-generation -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Auto-Generate Required:</strong> For security reasons, only administrators can manually enter secret values.
                            Please use the generate button to create a secure value.
                        </div>
                        <div class="input-group">
                            <textarea class="form-control" id="value" name="value" rows="4" required readonly
                                      placeholder="Click Generate to create a secure value...">{{ request.form.get('value', '') }}</textarea>
                            <button class="btn btn-primary" type="button" id="generateBtn" onclick="generateSecret()">
                                <i class="fas fa-magic me-1"></i>Generate Secure Value
                            </button>
                        </div>
                        <input type="hidden" name="generation_method" id="generation_method" value="auto">
                        {% endif %}

                        <div id="secretTypeHelp" class="form-text"></div>
                        <div id="valueValidation" class="mt-2"></div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <a class="text-decoration-none" data-bs-toggle="collapse" href="#advancedOptions">
                                    <i class="fas fa-cog me-2"></i>Advanced Options
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </a>
                            </h6>
                        </div>
                        <div class="collapse" id="advancedOptions">
                            <div class="card-body">
                                <!-- Expiration -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="expires_at" class="form-label">Expiration Date</label>
                                        <input type="datetime-local" class="form-control" id="expires_at" name="expires_at"
                                               value="{{ request.form.get('expires_at', '') }}">
                                        <div class="form-text">Leave empty for no expiration</div>
                                    </div>
                                </div>
                                
                                <!-- Auto-rotation -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="auto_rotate" name="auto_rotate"
                                                   {% if request.form.get('auto_rotate') %}checked{% endif %}
                                                   onchange="toggleRotationInterval()">
                                            <label class="form-check-label" for="auto_rotate">
                                                Enable Auto-Rotation
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rotation_interval_days" class="form-label">Rotation Interval (Days)</label>
                                        <input type="number" class="form-control" id="rotation_interval_days" 
                                               name="rotation_interval_days" min="1" max="365" 
                                               value="{{ request.form.get('rotation_interval_days', '90') }}"
                                               disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('secrets.index') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Secret
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Help Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Help & Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Secret Types</h6>
                <ul class="small">
                    <li><strong>String:</strong> Simple text value</li>
                    <li><strong>Password:</strong> User passwords with strength validation</li>
                    <li><strong>API Key:</strong> Service API keys and tokens</li>
                    <li><strong>SSH Key:</strong> SSH private keys</li>
                    <li><strong>RSA Key:</strong> RSA private keys</li>
                    <li><strong>Certificate:</strong> SSL/TLS certificates</li>
                    <li><strong>JSON:</strong> Structured JSON data</li>
                    <li><strong>YAML:</strong> YAML configuration</li>
                </ul>
                
                <h6 class="mt-3">Secrecy Levels</h6>
                <ul class="small">
                    <li><strong>Low:</strong> Non-sensitive configuration</li>
                    <li><strong>Medium:</strong> Standard business secrets</li>
                    <li><strong>High:</strong> Sensitive credentials</li>
                    <li><strong>Critical:</strong> Production system credentials</li>
                </ul>
                
                <h6 class="mt-3">Best Practices</h6>
                <ul class="small">
                    <li>Use descriptive names and descriptions</li>
                    <li>Set appropriate secrecy levels</li>
                    <li>Enable auto-rotation for critical secrets</li>
                    <li>Use the secret generator for strong values</li>
                    <li>Group related secrets by service</li>
                </ul>
            </div>
        </div>
        
        <!-- Secret Generator -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-magic me-2"></i>Secret Generator</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="genLength" class="form-label">Length</label>
                    <input type="range" class="form-range" id="genLength" min="8" max="128" value="32" 
                           oninput="updateLengthValue()">
                    <div class="d-flex justify-content-between">
                        <small>8</small>
                        <small id="lengthValue">32</small>
                        <small>128</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genUppercase" checked>
                        <label class="form-check-label" for="genUppercase">Uppercase (A-Z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genLowercase" checked>
                        <label class="form-check-label" for="genLowercase">Lowercase (a-z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genNumbers" checked>
                        <label class="form-check-label" for="genNumbers">Numbers (0-9)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genSymbols" checked>
                        <label class="form-check-label" for="genSymbols">Symbols (!@#$...)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genExcludeAmbiguous" checked>
                        <label class="form-check-label" for="genExcludeAmbiguous">Exclude ambiguous (0,O,l,1)</label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline-primary w-100" onclick="generateSecret()">
                    <i class="fas fa-magic me-2"></i>Generate Secret
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function updateSecretTypeHelp() {
    const secretType = document.getElementById('secret_type').value;
    const helpElement = document.getElementById('secretTypeHelp');
    
    const helpTexts = {
        'string': 'Simple text value for configuration or non-sensitive data.',
        'password': 'User password with strength validation and recommendations.',
        'api_key': 'API key or token for service authentication.',
        'ssh_key': 'SSH private key in OpenSSH or PEM format.',
        'rsa_key': 'RSA private key for encryption or signing.',
        'certificate': 'SSL/TLS certificate or certificate chain.',
        'json': 'Structured JSON data (will be validated).',
        'yaml': 'YAML configuration data.'
    };
    
    helpElement.textContent = helpTexts[secretType] || '';
}

function toggleRotationInterval() {
    const autoRotate = document.getElementById('auto_rotate').checked;
    const intervalField = document.getElementById('rotation_interval_days');
    intervalField.disabled = !autoRotate;
    if (autoRotate) {
        intervalField.required = true;
    } else {
        intervalField.required = false;
    }
}

function updateLengthValue() {
    const length = document.getElementById('genLength').value;
    document.getElementById('lengthValue').textContent = length;
}

function generateSecret() {
    const secretType = document.getElementById('secret_type').value;
    
    if (secretType === 'password' || secretType === 'string' || secretType === 'api_key') {
        generatePassword();
    } else if (secretType === 'ssh_key') {
        generateSSHKey();
    } else if (secretType === 'rsa_key') {
        generateRSAKey();
    } else {
        alert('Secret generation not supported for this type. Please enter the value manually.');
    }
}

function generatePassword() {
    // Simple client-side password generator (in production, consider server-side generation)
    const length = parseInt(document.getElementById('genLength').value);
    const includeUppercase = document.getElementById('genUppercase').checked;
    const includeLowercase = document.getElementById('genLowercase').checked;
    const includeNumbers = document.getElementById('genNumbers').checked;
    const includeSymbols = document.getElementById('genSymbols').checked;
    const excludeAmbiguous = document.getElementById('genExcludeAmbiguous').checked;
    
    let charset = '';
    if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
    if (includeNumbers) charset += '0123456789';
    if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
    
    if (excludeAmbiguous) {
        charset = charset.replace(/[0O1l]/g, '');
    }
    
    if (charset === '') {
        alert('Please select at least one character type.');
        return;
    }
    
    let password = '';
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    document.getElementById('value').value = password;

    // Update generation method to indicate this was auto-generated
    const generationMethodField = document.getElementById('generation_method');
    if (generationMethodField) {
        generationMethodField.value = 'auto';
    }

    validateSecretValue();
}

function generateSSHKey() {
    alert('SSH key generation requires server-side processing. Please use the API or enter manually.');
}

function generateRSAKey() {
    alert('RSA key generation requires server-side processing. Please use the API or enter manually.');
}

function validateSecretValue() {
    const value = document.getElementById('value').value;
    const secretType = document.getElementById('secret_type').value;
    const validationElement = document.getElementById('valueValidation');
    
    if (!value) {
        validationElement.innerHTML = '';
        return;
    }
    
    // Basic client-side validation (server-side validation is more comprehensive)
    if (secretType === 'password') {
        const strength = calculatePasswordStrength(value);
        validationElement.innerHTML = `
            <div class="alert alert-${strength.color} alert-sm py-2">
                <strong>Strength:</strong> ${strength.level}
                ${strength.warnings.length > 0 ? '<br><small>' + strength.warnings.join(', ') + '</small>' : ''}
            </div>
        `;
    } else {
        validationElement.innerHTML = '';
    }
}

function calculatePasswordStrength(password) {
    const length = password.length;
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSymbol = /[^A-Za-z0-9]/.test(password);
    
    let score = 0;
    let warnings = [];
    
    if (length >= 8) score += 1;
    else warnings.push('Use at least 8 characters');
    
    if (length >= 12) score += 1;
    if (hasUpper) score += 1;
    if (hasLower) score += 1;
    if (hasNumber) score += 1;
    if (hasSymbol) score += 1;
    
    if (!hasUpper) warnings.push('Add uppercase letters');
    if (!hasLower) warnings.push('Add lowercase letters');
    if (!hasNumber) warnings.push('Add numbers');
    if (!hasSymbol) warnings.push('Add symbols');
    
    if (score <= 2) return {level: 'Very Weak', color: 'danger', warnings};
    if (score <= 3) return {level: 'Weak', color: 'warning', warnings};
    if (score <= 4) return {level: 'Medium', color: 'info', warnings};
    if (score <= 5) return {level: 'Strong', color: 'success', warnings};
    return {level: 'Very Strong', color: 'success', warnings};
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateSecretTypeHelp();
    toggleRotationInterval();

    const valueField = document.getElementById('value');
    valueField.addEventListener('input', function() {
        // If user is typing manually, mark as manual entry (only for admins)
        const generationMethodField = document.getElementById('generation_method');
        if (generationMethodField && !valueField.readOnly) {
            generationMethodField.value = 'manual';
        }
        validateSecretValue();
    });
});
</script>
{% endblock %}